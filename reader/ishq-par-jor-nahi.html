<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ishq Par Jor Nahi - Episode <span id="epNumTitle"></span></title>
  <style>
    :root {
      --primary: #00d4ff;
      --dark: #0a001f;
      --gray: #111;
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      margin: 0;
      background: var(--dark);
      color: white;
      font-family: 'Segoe UI', sans-serif;
      min-height: 100vh;
      overflow-x: hidden;
      user-select: none;
      -webkit-user-select: none;
      touch-action: pan-y;
    }

    /* Header & Nav */
    #header {
      position: sticky;
      top: 0;
      background: rgba(10, 0, 31, 0.95);
      backdrop-filter: blur(10px);
      padding: 12px 20px;
      z-index: 1000;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid rgba(0, 212, 255, 0.2);
    }

    #nav button, #nav a {
      background: rgba(0, 212, 255, 0.15);
      color: var(--primary);
      border: 1px solid rgba(0, 212, 255, 0.3);
      padding: 8px 14px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      text-decoration: none;
      font-size: 0.9rem;
    }

    #nav button:hover, #nav a:hover {
      background: rgba(0, 212, 255, 0.35);
      transform: translateY(-1px);
    }

    /* Fast Loading Spinner */
    #loading {
      position: fixed;
      inset: 0;
      background: var(--dark);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 999;
      transition: opacity 0.4s;
    }

    #loading.hidden { opacity: 0; pointer-events: none; }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(0, 212, 255, 0.1);
      border-top: 4px solid var(--primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    /* Comic Container Optimization */
    #comic {
      max-width: 900px; /* Reading ke liye best width */
      margin: 0 auto;
      display: flex;
      flex-direction: column;
    }

    .page {
      width: 100%;
      min-height: 300px; /* Placeholder height */
      background: rgba(255,255,255,0.02);
      margin-bottom: 0; /* Webtoon style gapless */
      opacity: 0;
      transition: opacity 0.5s ease;
    }

    .page.loaded { opacity: 1; }

    .page img {
      width: 100%;
      height: auto;
      display: block;
    }

    #pageCounter {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: rgba(0,0,0,0.8);
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 0.85rem;
      border: 1px solid rgba(0,212,255,0.2);
      z-index: 998;
    }

    #next-episode-notice {
      text-align: center;
      padding: 50px 20px;
      color: #777;
    }

    @keyframes spin { 100% { transform: rotate(360deg); } }
  </style>
</head>
<body oncontextmenu="return false;">

  <div id="header">
    <h1 id="title" style="font-size: 1.2rem;">EPISODE-<span id="epNumDisplay"></span></h1>
    <div id="nav">
      <button onclick="prevEpisode()">Prev</button>
      <button onclick="nextEpisode()">Next</button>
      <a href="../pages/ishq-par-jor-nahi.html">Back</a>
    </div>
  </div>

  <div id="loading">
    <div class="spinner"></div>
    <p style="margin-top:15px; font-size:0.9rem; color:var(--primary);">Palkein na jhapkayein... üê∞</p>
  </div>

  <div id="comic"></div>
  
  <div id="pageCounter">Loading...</div>
  
  <div id="next-episode-notice">Next episode will be uploaded on Monday</div>

  <script>
    // 1. Security Check
    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
      return "";
    }

    if (getCookie("site_access") !== "true") {
      document.body.innerHTML = `<div style="padding:50px; text-align:center; background:#900; color:#fff;">‚ö†Ô∏è Direct Access Blocked. Solve shortener first. <br><br> <a href="https://gplinks.co/BFmfakvr" style="color:yellow;">Unlock Here</a></div>`;
      throw new Error("Access Blocked");
    }

    // 2. Config
    const urlParams = new URLSearchParams(window.location.search);
    const episode = parseInt(urlParams.get('ep')) || 1;
    const comicSlug = 'ishq-par-jor-nahi';
    const paddedEp = episode.toString().padStart(2, '0');
    const basePath = `https://cdn.jsdelivr.net/gh/maxton480/Comics@main/comics/${comicSlug}/ch${paddedEp}/`;
    
    document.getElementById('epNumDisplay').textContent = episode;
    document.getElementById('epNumTitle').textContent = episode;

    const comicContainer = document.getElementById('comic');
    const loading = document.getElementById('loading');
    const pageCounter = document.getElementById('pageCounter');
    
    let loadedCount = 0;
    const maxPages = 200;
    const maxAllowed = 30;

    // 3. Batch Loading Logic (The Speed Booster)
    async function startReading() {
      if (episode > maxAllowed) {
        loading.classList.add('hidden');
        comicContainer.innerHTML = '<p style="padding:100px; text-align:center;">Episode Not Released Yet.</p>';
        return;
      }

      let i = 1;
      let active = true;
      const batchSize = 6; // 6 images ek saath load karega

      while (active && i <= maxPages) {
        const batch = [];
        for (let j = 0; j < batchSize; j++) {
          if (i + j <= maxPages) batch.push(loadSinglePage(i + j));
        }

        const results = await Promise.all(batch);
        if (results.includes(false)) active = false; // Stop if image not found
        i += batchSize;
        
        // Pehli 2-3 images load hote hi screen dikha do
        if (loadedCount >= 1) loading.classList.add('hidden');
      }
    }

    function loadSinglePage(index) {
      return new Promise((resolve) => {
        const num = index.toString().padStart(3, '0');
        const img = new Image();
        img.src = `${basePath}${num}.webp`;
        
        const div = document.createElement('div');
        div.className = 'page';

        img.onload = () => {
          loadedCount++;
          pageCounter.textContent = `Pages: ${loadedCount}`;
          div.appendChild(img);
          comicContainer.appendChild(div);
          setTimeout(() => div.classList.add('loaded'), 50);
          resolve(true);
        };

        img.onerror = () => {
          resolve(false);
        };
      });
    }

    // Start
    startReading();

    // 4. Nav & Anti-Theft
    function prevEpisode() { if(episode > 1) window.location.href = `?ep=${episode - 1}`; }
    function nextEpisode() { if(episode < maxAllowed) window.location.href = `?ep=${episode + 1}`; }

    if (episode === maxAllowed) document.getElementById('next-episode-notice').style.display = 'block';
    else document.getElementById('next-episode-notice').style.display = 'none';

    // Anti-Download
    document.addEventListener('contextmenu', e => e.preventDefault());
    document.addEventListener('keydown', e => {
      if (e.ctrlKey && ['s','u','p','c','a','i'].includes(e.key.toLowerCase())) e.preventDefault();
    });
  </script>
</body>
</html>
